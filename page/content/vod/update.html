<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>添加</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet"  href="../../../resource/plugins/layui/css/layui.css" media="all">
</head>

<body>
<div class="layui-tab gos-body">
    <ul class="layui-tab-title">
        <li class="layui-this">基础信息设置</li>
        <li>剧集信息设置</li>

    </ul>
    <div class="layui-tab-content ">
        <div class="layui-tab-item layui-show">
            <form  class="layui-form gos-form" autocomplete="on"  enctype="multipart/form-data">
                <!-- enctype="multipart/form-data" 不对字符编码。在使用包含文件上传控件的表单时，必须使用该值。-->
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <div class="layui-input-block">
                            <select name="categoryid" lay-filter="categoryAdd" id="categorySelectAdd">
                                <option value="">请选择片源样式</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <div class="layui-input-block">
                            <select name="classid" lay-filter="clazzAdd" id="clazzSelectAdd">
                                <option value="">请选择片源风格</option>
                            </select>
                        </div>
                    </div>

                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">影片名称：</label>
                    <div class="layui-input-block">
                        <input type="text" name="moviename" lay-verify="required" placeholder="请输入影片名称"  class="layui-input" value="testMovieName">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">

                        <label class="layui-form-label">是否付费：</label>
                        <div class="layui-input-block">
                            <input type="checkbox"   value="1" name="ispay" lay-skin="switch" lay-filter="switchTest" lay-text="是|否">
                        </div>
                    </div>
                    <div class="layui-inline">

                        <label class="layui-form-label">参考价格：</label>
                        <div class="layui-input-block">
                            <input type="text" name="referenceprice" lay-verify="content"  placeholder="" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">

                        <label class="layui-form-label">是否加锁：</label>
                        <div class="layui-input-block">
                            <input type="checkbox"  value="1" name="islock" lay-skin="switch" lay-filter="switchTest" lay-text="是|否">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">限制级：</label>
                        <div class="layui-input-block">
                            <select name="level" lay-filter="" lay-verify="required">
                                <option value="0" selected>限制级1</option>
                                <option value="1">限制级2</option>
                                <option value="2">限制级3</option>
                                <option value="3">限制级4</option>
                                <option value="4">限制级5</option>
                            </select>
                        </div>

                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label ">影片海报：</label>
                    <div class="layui-input-block">
                        <div class="layui-upload-drag " id="upload" >
                            <i class="layui-icon"></i>
                            <p >点击上传，或将文件拖拽到此处</p>
                        </div>
                        <div class="layui-inline">
                            <img src="" >
                        </div>
                    </div>


                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">剧集：</label>
                    <div class="layui-input-block">
                        <input type="text" name="episodes" lay-verify="content"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">更新频率：</label>
                    <div class="layui-input-block">
                        <input type="text" name="updatefrequency" lay-verify="content"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">上映时间：</label>
                    <div class="layui-input-block">
                        <input type="text" name="releasedate" id="date1"  class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">语言：</label>
                    <div class="layui-input-block">
                        <input type="text" name="language" lay-verify="content"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">评分：</label>
                    <div class="layui-input-block">
                        <input type="text" name="score" lay-verify="content"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">影片导演：</label>
                    <div class="layui-input-block">
                        <input type="text" name="director" lay-verify="content"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">影片演员：</label>
                    <div class="layui-input-block">
                        <input type="text" name="actor" lay-verify="content1"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">上映地点：</label>
                    <div class="layui-input-block">
                        <input type="text" name="area" lay-verify="content2"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">发行公司：</label>
                    <div class="layui-input-block">
                        <input type="text" name="rcompany" lay-verify="content3"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">版权单位：</label>
                    <div class="layui-input-block">
                        <input type="text" name="copyright" lay-verify="content4"  placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">影片简介：</label>
                    <div class="layui-input-block">
                        <textarea placeholder="请输入内容" name="content" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <button class="layui-btn layui-input-block" lay-submit="" >提交</button>
                </div>
            </form>
        </div>
        <div class="layui-tab-item gos-tab-item ">
          <iframe id="episodeIframe" height="99%" width="100%" style="border:0"></iframe>
        </div>
        <div class="layui-tab-item">内容3</div>
    </div>
</div>


<ul class="layui-fixbar" style="right: 50px; bottom: 100px;">
    <li class="layui-icon" lay-type="bar1" style="background-color:#393D49"></li>
    <li class="layui-icon" lay-type="bar2" style="background-color:#393D49"></li>
    <li class="layui-icon layui-fixbar-top" lay-type="top" style="background-color:#393D49"></li>
</ul>

<script src="../../../resource/plugins/layui/layui.js" charset="utf-8"></script>

<script>
    layui.config({
        base:"../../../resource/js/"
    }).use(['ott','form', 'layedit', 'laydate', 'upload', 'util', 'layer', 'jquery','element'], function(){
        var form = layui.form
                ,layer = layui.layer
                ,layedit = layui.layedit
                ,laydate = layui.laydate
                ,upload = layui.upload
                ,util = layui.util
                ,$ = layui.$
                ,element = layui.element;

        /*ott 信息 -- start*/
        var ott = layui.ott;
        var moduleName = ott.dict.constant.module.vod;
        var moduleInfo = ott.module.getInfo(moduleName);

        var url = moduleInfo.url;
        var submitUrl = '';     //表单提交地址
        var dict = moduleInfo.dict;
        var utils = ott.myutils;
        var updateType = ott.dict.constant.updateType;

        var http = ott.http;
        var select = ott.select;

        var baseInfoSubmit = false;     //基础信息是否提交

        var type ;          //类型
        var movieId = -1;   //电影id 提交成功后返回
        var queryObj;        //编辑时 查询到的信息


        init();

        function init(){
            initTab();
            initForm();
            initSelect();
            initPageLang();

            initParam();
        }

        function initParam(){
            type = utils.getUpdateType();
            console.info("更新类型:"+type);
            if(type == updateType.add){
                submitUrl = url.addBase;
            }else if(type == updateType.edit){

                movieId = utils.getId();
                console.info("id:"+movieId);

                submitUrl = url.editBase;
                http.post({
                    url:url.loadBase,
                    data:{movieId:movieId},
                    success:function(data){
                        utils.setValue(data.object);
                        queryObj = data.object;
                        console.info(data.object.categoryid);
                        if(data.object.categoryid){
                            console.info( $("#categorySelectAdd").next().find("[lay-value='"+data.object.categoryid+"']"));
                            $("#categorySelectAdd").next().find("[lay-value='"+data.object.categoryid+"']").click();
                        }

                        //$two:$("#clazzSelectAdd")
                        form.render(); //更新全部
                    }
                })

            }
        }

       /*初始化表单*/
        function initForm(){
            //日期
            laydate.render({
                elem: '#date1'
            });
            laydate.render({
                elem: '#date2'
            });


            //自定义验证规则
            form.verify({
                title: function(value){
                    if(value.length < 5){
                        return '标题至少得5个字符啊';
                    }
                }
                ,pass: [/(.+){6,12}$/, '密码必须6到12位']
                ,content: function(value){
                    layedit.sync(editIndex);
                }
            });

            //监听指定开关
            form.on('switch(switchTest)', function(data){
                /* layer.msg('开关checked：'+ (this.checked ? 'true' : 'false'), {
                 offset: '6px'
                 });*/
                //layer.tips('', data.othis)
            });

            //监听提交
            form.on('submit', function(data){
                http.submit({
                    url:url.addBase,
                    elem:'.layui-form', //元素选择器
                    success:function(data){
                        baseInfoSubmit = true;
                        layer.msg('提交成功', {icon: 1,time:1000});//0警告 1 ok 2 错误
                        movieId = 1;    //保存电影id

                        var $refresh = parent.layui.$("#refresh");
                        if(1 == $refresh.length){
                            $refresh.click();    //刷新
                        }

                        console.info( $(".layui-tab-title li:eq(1)"));
                        $(".layui-tab-title li:eq(1)").click();//跳转到剧集信息
                    },
                    fail:function(data){
                        layer.msg('提交失败', {icon: 2,time:1000});//0警告 1 ok 2 错误
                    }
                });
                return false;
            });

            //拖拽上传
            upload.render({
                elem: '#upload'
                ,auto: false
                ,field:'imgfile'
                ,done: function(res){
                    console.log(res)
                }
            });

            //固定块
            util.fixbar({
                bar1: true
                ,bar2: true
                ,css: {right: 50, bottom: 100}
                ,bgcolor: '#393D49'
                ,click: function(type){
                    if(type === 'bar1'){
                        layer.msg('icon是可以随便换的')
                    } else if(type === 'bar2') {
                        layer.msg('两个bar都可以设定是否开启')
                    }
                }
            });
        }

        /*初始化tab*/
        function initTab(){
            element.on('tab',function(data){
                if(type == updateType.add){
                    if((data.index==1)&& (!baseInfoSubmit)){    //如果没有提交，禁止切换剧集页面
                        layer.msg("请先提交基本信息",{
                            time:1000,
                            icon:2
                        });
                        console.error("如果没有提交，禁止切换剧集页面");
                        return false;
                    }
                }else if(type == updateType.edit){

                }

                if(data.index== 1){
                    $("#episodeIframe").attr("src","../episode/index.html?id="+movieId+"&"+updateType.key+"="+type);
                }

            });
        }

        /*初始化下拉框*/
        function initSelect(){
            select.set({
                oneSelectChange: function (data) {        //第一个下拉改变事件回调
                    var cid = data.value;
                    console.info( cid);

                    setTimeout(function(){  //延时第一个下拉框改变时需要请求第二个下拉框的数据 （暂时这样处理）
                        if(type == updateType.edit){
                            if(queryObj.classid){
                                console.info( $("#clazzSelectAdd").next().find("[lay-value='"+queryObj.classid+"']"));
                                $("#clazzSelectAdd").next().find("[lay-value='"+queryObj.classid+"']").click();
                            }
                        }
                    },500);

                },
                twoSelectChange: function (data) {       //第二个下拉改变事件回调
                    var classid = data.value;
                    console.info( classid);


                },
                oneField:'select(categoryAdd)',        //
                twoField:'select(clazzAdd)',
                $one:$("#categorySelectAdd"),                            //第一个下拉的jquery元素
                $two:$("#clazzSelectAdd")
            }).init();
        }

        /*初始化页面语言*/
        function  initPageLang(){
            utils.setLang(dict);
        }
    });

</script>
</body>
</html>